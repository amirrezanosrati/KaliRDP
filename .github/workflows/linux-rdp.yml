name: Ubuntu Desktop with Debug
on:
  workflow_dispatch:

jobs:
  ubuntu-desktop:
    runs-on: ubuntu-latest
    steps:
    - name: Install and Setup Desktop
      run: |
        sudo apt-get update
        # ŸÜÿµÿ® Ÿæ⁄©€åÿ¨‚ÄåŸáÿß
        sudo apt-get install -y xfce4 xrdp firefox
        
        # ÿß€åÿ¨ÿßÿØ ⁄©ÿßÿ±ÿ®ÿ±
        sudo useradd -m -s /bin/bash user
        echo "user:password123" | sudo chpasswd
        
        # ÿ™ŸÜÿ∏€åŸÖ Xsession
        echo "xfce4-session" > ~/.xsession
        sudo chown user:user ~/.xsession
        
        # ÿ™ŸÜÿ∏€åŸÖ XRDP
        sudo sed -i 's/port=3389/port=3390/g' /etc/xrdp/xrdp.ini
        sudo systemctl restart xrdp
        sleep 3

    - name: Debug Information
      run: |
        echo "üîß DEBUG INFORMATION:"
        echo "======================"
        sudo systemctl status xrdp --no-pager
        echo ""
        echo "üì° Port listening:"
        sudo netstat -tuln | grep 3390 || echo "Port 3390 not found"
        echo ""
        echo "üë§ User info:"
        id user
        echo ""
        echo "üìÅ Xsession file:"
        ls -la ~/.xsession
        cat ~/.xsession
        echo "======================"

    - name: Setup Ngrok
      run: |
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        chmod +x ngrok
        ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        ./ngrok tcp 3390 --log=stdout > ngrok.log 2>&1 &
        sleep 20

    - name: Get Connection Info
      run: |
        # ÿØÿ±€åÿßŸÅÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ™ŸàŸÜŸÑ
        TUNNEL_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
        if [ -n "$TUNNEL_URL" ]; then
            IP=$(echo "$TUNNEL_URL" | cut -d':' -f2 | sed 's#//##')
            PORT=$(echo "$TUNNEL_URL" | cut -d':' -f3)
        else
            IP="0.tcp.ngrok.io"
            PORT="3390"
        fi
        
        echo "IP=$IP" >> $GITHUB_ENV
        echo "PORT=$PORT" >> $GITHUB_ENV

    - name: Display Info
      run: |
        echo "=========================================="
        echo "üñ•Ô∏è  CONNECTION INFORMATION"
        echo "=========================================="
        echo "Address: ${{ env.IP }}"
        echo "Port: ${{ env.PORT }}"
        echo "Username: user"
        echo "Password: password123"
        echo ""
        echo "üîß If connection fails, check:"
        echo "1. Ngrok status above"
        echo "2. XRDP service status"
        echo "3. Port 3390 listening"
        echo "=========================================="

    - name: Test Connection
      run: |
        echo "üß™ Testing connection..."
        # ÿ™ÿ≥ÿ™ ÿß€åŸÜ⁄©Ÿá ŸæŸàÿ±ÿ™ Ÿæÿßÿ≥ÿÆ ŸÖ€å‚ÄåÿØŸáÿØ
        timeout 5 nc -zv localhost 3390 && echo "‚úÖ Port 3390 is open" || echo "‚ùå Port 3390 not accessible"
        
        # ÿ™ÿ≥ÿ™ Ngrok
        curl -s http://localhost:4040/api/tunnels > tunnels.json
        if [ -s tunnels.json ]; then
            echo "‚úÖ Ngrok is working"
        else
            echo "‚ùå Ngrok not responding"
            cat ngrok.log || echo "No ngrok log"
        fi

    - name: Keep Alive
      run: |
        echo "üü¢ System is running. Check debug info above."
        echo "‚è∞ Waiting for connection..."
        while true; do
            sleep 30
        done
